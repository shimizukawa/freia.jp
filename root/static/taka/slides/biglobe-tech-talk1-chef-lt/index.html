<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chefの 環境別設定が 難しい話</title>
    
    <link rel="stylesheet" href="_static/s6.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/jquery.touchwipe.min.js"></script>
    <script type="text/javascript" src="_static/s6.js"></script>
    <script type="text/javascript" src="_static/s6-sphinx.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>

  </head>
  <body>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li><a href="#">Pythonな会社でchefしてる例の紹介 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="chef">
<h1>Chefの 環境別設定が 難しい話<a class="headerlink" href="#chef" title="このヘッドラインへのパーマリンク">¶</a></h1>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'h1': {marginTop:'0.5em', fontSize: '270%', wordBreak: 'keep-all'}}});}</script>
<div class="section" id="id1">
<h2>おまえ、誰よ<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="figure">
<img alt="_images/face.png" src="_images/face.png" />
</div>
<ul>
<li><p class="first"><a class="reference external" href="http://清水川.jp/">http://清水川.jp/</a>
<a class="reference external" href="http://twitter.com/shimizukawa">&#64;shimizukawa</a></p>
</li>
<li><dl class="first docutils">
<dt>活動:</dt>
<dd><ul class="first last simple">
<li>ドキュメントツールSphinxのメンテナ</li>
<li>Sphinx-users.jp 会長</li>
<li>Python系, PyConJP系, XP系</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>言語:</dt>
<dd><ul class="first last simple">
<li>C++/C/8086/<strong>Python</strong>/Rails/chef</li>
</ul>
</dd>
</dl>
</li>
</ul>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'ul': {fontSize:'128%'},
'div[0]': {width:'15%', position:'absolute', top:'1em', right:'1em'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="id2">
<h2>所属<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="figure">
<img alt="_images/beproud_logo.png" src="_images/beproud_logo.png" />
</div>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'h2': {fontSize:'120%', textAlign:'center'},
'div[0]/img': {margin:'2em', marginTop:'1.5em', width:'80%', backgroundColor:'white'},
'div/img': {border:'0.1em gray outset'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="pycon-apac-2013-in-japan">
<h2>宣伝: PyCon APAC 2013 in Japan<a class="headerlink" href="#pycon-apac-2013-in-japan" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="figure">
<img alt="_images/pyconapac2013.png" src="_images/pyconapac2013.png" />
</div>
<ul class="simple">
<li>Schedule:<ul>
<li>カンファレンス: 9月, 14(Sat) 15(Sun)</li>
<li>スプリント: 9月, 16(Mon)</li>
</ul>
</li>
<li>Location:<ul>
<li>東京 新宿</li>
</ul>
</li>
<li>参加登録:<ul>
<li>6月中に開始予定</li>
</ul>
</li>
</ul>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'div[0]': {width:'17%', position:'absolute', top:'4em', right:'0'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="id3">
<h2>Chefで使っているツール等<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li>knife-solo-0.3.0.pre4 : soro.rbいらず</li>
<li>knife-solo_data_bag : knife-soloで暗号化data-bags</li>
<li>capistrano-paratrooper-chef : chef-solo並列実行</li>
<li>cookbooks :<ul>
<li>yum, git, hostname, openssh, selinux, sudo, timezone, user, screen</li>
<li>rbenv, ruby_build, jenkins, memcached, mysql, nginx, postfix</li>
<li>python-build, mercurial-env, shimizukawa-env</li>
</ul>
</li>
</ul>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'ul': {fontSize:'70%'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="case1">
<h2>Case1<a class="headerlink" href="#case1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'h2': {textAlign:'center', margin:'30% auto', lineHeight:'1.5em'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="id4">
<h2>Case1: 配置するファイルが異なる<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>例:</p>
<ul class="simple">
<li>nginxのSSL鍵ファイル</li>
<li>upstartに書くアプリケーションの設定ファイルpath</li>
</ul>
</div>
<div class="section" id="id5">
<h2>Case1: 配置するファイルが異なる<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>現状:</p>
<ul class="simple">
<li>chef-serverであればenvironmentで環境別にattributeを設定できる。
<a class="reference external" href="http://docs.opscode.com/essentials_environments.html">About Environments - Chef Docs</a></li>
<li>chef-soloだと11.4.4では使えないがchefのリポジトリ上では対応済みらしい。
<a class="reference external" href="https://github.com/opscode/chef/pull/649">CHEF-3356 Adds support for environments when running under chef-solo</a></li>
</ul>
</div>
<div class="section" id="case2">
<h2>Case2<a class="headerlink" href="#case2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'h2': {textAlign:'center', margin:'30% auto', lineHeight:'1.5em'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="case2-run-list">
<h2>Case2: 実行したいrun_listが異なる<a class="headerlink" href="#case2-run-list" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>例:</p>
<ul class="simple">
<li>社内環境でだけjenkinsもrun_listに含めたい</li>
</ul>
</div>
<div class="section" id="id6">
<h2>Case2: 実行したいrun_listが異なる<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>現状:</p>
<ul class="simple">
<li>chef-serverであればrole定義内のenv_run_listが使える。
<a class="reference external" href="http://docs.opscode.com/essentials_environments.html">About Environments - Chef Docs</a></li>
<li>chef-soloだと11.4.4では使えないがchefのリポジトリ上では対応済みらしい。
<a class="reference external" href="https://github.com/opscode/chef/pull/649">CHEF-3356 Adds support for environments when running under chef-solo</a></li>
</ul>
</div>
<div class="section" id="case3">
<h2>Case3<a class="headerlink" href="#case3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'h2': {textAlign:'center', margin:'30% auto', lineHeight:'1.5em'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="case3-ssh">
<h2>Case3: ユーザーのssh設定が異なる<a class="headerlink" href="#case3-ssh" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>例:</p>
<ul class="simple">
<li>.ssh以下のファイルは本番サーバーと開発サーバーで変えたい<ul>
<li>.ssh/authorized_keys</li>
<li>.ssh/config</li>
<li>.ssh/鍵</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id7">
<h2>Case3: ユーザーのssh設定が異なる<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>現状:</p>
<ul class="simple">
<li>user作成レシピはcommunityやgithubのものを含めてたくさんあるがenvironmentには対応していないし、chef-soloで使えないuserレシピが多い<ul>
<li><a class="reference external" href="http://community.opscode.com/cookbooks/user">http://community.opscode.com/cookbooks/user</a></li>
<li><a class="reference external" href="http://community.opscode.com/cookbooks/users">http://community.opscode.com/cookbooks/users</a></li>
<li><a class="reference external" href="https://github.com/libero18/user">https://github.com/libero18/user</a></li>
<li><a class="reference external" href="https://github.com/">https://github.com/</a>...</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="case4">
<h2>Case4<a class="headerlink" href="#case4" title="このヘッドラインへのパーマリンク">¶</a></h2>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'h2': {textAlign:'center', margin:'30% auto', lineHeight:'1.5em'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="case4-cookbook">
<h2>Case4: 自作cookbookを環境対応したい<a class="headerlink" href="#case4-cookbook" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>例:</p>
<ul class="simple">
<li>/etc/hostsの内容を細かく制御したい</li>
<li>iptablesのルールを細かく制御したい</li>
</ul>
<p>でも既存のcookbookではenvironmentに対応していないものが多い</p>
</div>
<div class="section" id="id8">
<h2>Case4: 自作cookbookを環境対応したい<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>無いなら自分で作るしか！！</p>
<ul class="simple">
<li>でも私はchef-soloユーザー</li>
<li>chef_environmentは chef-solo 11.4.4では使えない</li>
<li>node.my_environment を持たせて頑張ってみた</li>
</ul>
</div>
<div class="section" id="chef-docs">
<h2>Chef Docs 推奨のデータ構造<a class="headerlink" href="#chef-docs" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre>{
   &quot;id&quot;: &quot;www&quot;,
   &quot;ssh_keys&quot;: {
      &quot;production&quot;: [
         &quot;ssh-rsa AAAB3Scw....&quot;,
         &quot;ssh-rsa AAA2GsCn....&quot;,
         ...
      ],
      &quot;staging&quot;: [
         ...
      ],
      &quot;develop&quot;: [
         ...
      ]
   }
}
</pre></div>
</td></tr></table></div>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'div/table': {fontSize: '120%'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="id9">
<h2>より細かく制御できる構造<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre>{
   &quot;id&quot;: &quot;www&quot;,
   &quot;ssh_keys&quot;: [
      {
         &quot;envnode&quot;: [
            &quot;production/*&quot;,
            &quot;staging/*&quot;,
            &quot;develop/*&quot;
         ],
         &quot;keys&quot;: [
            &quot;ssh-rsa AAAB3Scw....&quot;
         ]
      }
      {
         &quot;envnode&quot;: [
            &quot;production/node1&quot;,
            &quot;production/node2&quot;,
            &quot;staging/*&quot;,
         ],
         &quot;keys&quot;: [
            &quot;ssh-rsa AAA2GsCn....&quot;,
            ...
         ]
      }
   ]
}
</pre></div>
</td></tr></table></div>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'div/table': {fontSize: '95%'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="questions">
<h2>Questions?<a class="headerlink" href="#questions" title="このヘッドラインへのパーマリンク">¶</a></h2>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'h2': {textAlign:'center', margin:'30% auto', lineHeight:'1.5em'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
<div class="section" id="id10">
<h2>ありがとうございました<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h2>
<script>
if(typeof s6 != 'undefined'){s6.page({styles: {'h2': {textAlign:'center', margin:'30% auto', lineHeight:'1.5em'}}});}</script>
<script>
if(typeof s6 != 'undefined'){s6.page({effect: 'slide'});}</script>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li><a href="#">Pythonな会社でchefしてる例の紹介 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
<div class="footer">
    <span>Chefの 環境別設定が 難しい話 :: 2013, Takayuki SHIMIZUKAWA</span><br />
    <span class="hidden">操作方法: 上下左右キーで操作です</span>
</div>

  </body>
</html>