box: shimizukawa/freia.jp

build:
  steps:
    - script:
        name: echo python information
        code: |
          echo "python version $(python --version) running"
          echo "pip version $(pip --version) running"
          echo "sphinx-build version $(sphinx-build --version) running"
    - script:
        name: restore build cache
        code: |
          if [ -d "$WERCKER_CACHE_DIR/build/doctrees" ]; then
            cp -Rp $WERCKER_CACHE_DIR/build/doctrees site/build/doctrees
          fi
          if [ -d "$WERCKER_CACHE_DIR/build/html" ]; then
            cp -Rp $WERCKER_CACHE_DIR/build/html site/build/html
          fi
    - script:
        name: build html
        code: |
          sphinx-build -M html site/source site/build -N -T
    - script:
        name: echo status
        code: |
          echo "$(git status)"
    - script:
        name: store build cache
        code: |
          rm -Rf $WERCKER_CACHE_DIR/build
          mkdir -p $WERCKER_CACHE_DIR/build
          cp -Rp site/build/doctrees $WERCKER_CACHE_DIR/build/doctrees
          cp -Rp site/build/html $WERCKER_CACHE_DIR/build/html

deploy:
  steps:
    - s3sync:
        key-id: $S3_KEY
        key-secret: $S3_SECRET
        bucket-url: s3://www.freia.jp/taka/
        source-dir: site/build/html
        opts: --acl-public
        delete-removed: false

    - s3sync:
        key-id: $S3_KEY
        key-secret: $S3_SECRET
        bucket-url: s3://www.freia.jp/
        source-dir: root/static/
        opts: --acl-public
        delete-removed: false
